<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Data Consulting - Document Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
        }
        .progress-fill {
            transition: width 0.6s ease;
        }
        .upload-section {
            transition: all 0.3s ease;
        }
        .upload-section.active {
            border-color: #6366f1;
            background: #f0f4ff;
        }
        .upload-section.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }
        .file-info {
            display: none;
        }
        .file-info.show {
            display: block;
        }
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .alert {
            transition: opacity 0.3s ease;
        }
        .candidate-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            color: white;
        }
        .success-animation {
            animation: bounce 0.6s ease-in-out;
        }
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-center py-12 px-6 relative">
            <div class="absolute inset-0 bg-[radial-gradient(circle,rgba(255,255,255,0.1)_0%,transparent_70%)] animate-pulse"></div>
            <h1 class="text-4xl font-bold relative z-10">üìÑ Document Upload</h1>
            <p class="text-lg mt-2 opacity-90 relative z-10" id="candidateGreeting">Loading candidate information...</p>
            
            <!-- Candidate Info Card -->
            <div class="candidate-info relative z-10 max-w-md mx-auto" id="candidateInfoCard" style="display: none;">
                <div class="grid grid-cols-1 gap-2 text-sm">
                    <div><strong>Position:</strong> <span id="candidatePosition">-</span></div>
                    <div><strong>Department:</strong> <span id="candidateDepartment">-</span></div>
                    <div><strong>Start Date:</strong> <span id="candidateStartDate">-</span></div>
                    <div><strong>HR Rep:</strong> <span id="candidateHR">-</span></div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="p-8">
            <!-- Progress Indicator -->
            <div class="text-center mb-10">
                <div class="flex justify-center gap-4 mb-4">
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600" id="step1">1</div>
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600" id="step2">2</div>
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600" id="step3">3</div>
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600" id="step4">‚úì</div>
                </div>
                <div class="bg-gray-200 h-2 rounded-full overflow-hidden">
                    <div class="progress-fill bg-gradient-to-r from-indigo-500 to-purple-600 h-full rounded-full" id="progressFill" style="width: 0%"></div>
                </div>
                <p class="mt-4 text-gray-600">Complete all three document uploads to proceed</p>
            </div>

            <!-- Upload Sections -->
            <div class="space-y-6">
                <!-- Identity Proof -->
                <div class="upload-section active border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center" id="identitySection">
                    <h3 class="text-xl font-semibold text-gray-800">üÜî Identity Proof</h3>
                    <p class="text-gray-600 mt-2">Upload your Driver's License, Passport, or Government ID</p>
                    <label for="identityFile" class="mt-4 inline-block px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg cursor-pointer hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md">Choose File</label>
                    <input type="file" id="identityFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload('identity')">
                    <div class="file-info mt-4 bg-white p-4 rounded-lg shadow-sm border border-green-200" id="identityInfo">
                        <p><strong>Selected:</strong> <span id="identityFileName"></span></p>
                        <p><strong>Size:</strong> <span id="identityFileSize"></span></p>
                        <p class="text-green-600 text-sm mt-2">‚úì File uploaded successfully</p>
                    </div>
                </div>

                <!-- Address Proof -->
                <div class="upload-section border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center" id="addressSection">
                    <h3 class="text-xl font-semibold text-gray-800">üè† Address Proof</h3>
                    <p class="text-gray-600 mt-2">Upload Utility Bill, Bank Statement, or Lease Agreement (not older than 3 months)</p>
                    <label for="addressFile" class="mt-4 inline-block px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg cursor-pointer hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md">Choose File</label>
                    <input type="file" id="addressFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload('address')">
                    <div class="file-info mt-4 bg-white p-4 rounded-lg shadow-sm border border-green-200" id="addressInfo">
                        <p><strong>Selected:</strong> <span id="addressFileName"></span></p>
                        <p><strong>Size:</strong> <span id="addressFileSize"></span></p>
                        <p class="text-green-600 text-sm mt-2">‚úì File uploaded successfully</p>
                    </div>
                </div>

                <!-- Offer Letter -->
                <div class="upload-section border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center" id="offerSection">
                    <h3 class="text-xl font-semibold text-gray-800">üìã Signed Offer Letter</h3>
                    <p class="text-gray-600 mt-2">Upload the signed offer letter we sent you</p>
                    <label for="offerFile" class="mt-4 inline-block px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg cursor-pointer hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md">Choose File</label>
                    <input type="file" id="offerFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload('offer')">
                    <div class="file-info mt-4 bg-white p-4 rounded-lg shadow-sm border border-green-200" id="offerInfo">
                        <p><strong>Selected:</strong> <span id="offerFileName"></span></p>
                        <p><strong>Size:</strong> <span id="offerFileSize"></span></p>
                        <p class="text-green-600 text-sm mt-2">‚úì File uploaded successfully</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between mt-8">
                <a href="/onboarding" class="px-6 py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all shadow-md">‚Üê Back</a>
                <button id="submitBtn" class="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md disabled:opacity-50" disabled onclick="submitDocuments()">Submit Documents</button>
            </div>

            <!-- Alert -->
            <div id="alert" class="hidden mt-4 p-4 rounded-lg"></div>
        </div>
    </div>

    <script>
        let uploadedFiles = {
            identity: null,
            address: null,
            offer: null
        };

        let candidateData = {
            id: null,
            name: "",
            email: "",
            phone: "",
            position: "",
            department: "",
            startDate: "",
            buddyEmail: "",
            buddyName: "",
            hrRep: "",
            status: "Documents Pending"
        };

        // Configuration
        const AIRTABLE_CONFIG = {
            baseId: 'appMvECrw7CrJFCO0',
            tableId: 'tblqaH9RrTO6JuG5N',
            apiKey: 'AIRTABLE_API_KEY' // Replace with your actual API key
        };

        // Initialize form with candidate data
        async function initializeCandidateData() {
            const params = new URLSearchParams(window.location.search);
            
            // Extract all parameters from URL (populated by n8n)
            candidateData = {
                id: params.get('recordId') || 'Unknown ID',
                name: params.get('candidateName') || params.get('Name') || 'Unknown Name',
                email: params.get('candidateEmail') || params.get('Email') || 'unknown@example.com',
                phone: params.get('candidatePhone') || params.get('Phone') || 'Unknown Phone',
                position: params.get('position') || params.get('Position') || 'Unknown Position',
                department: params.get('department') || params.get('Department') || 'Unknown Department',
                startDate: params.get('startDate') || params.get('Start Date') || 'Unknown Date',
                buddyEmail: params.get('buddyEmail') || params.get('Buddy Email') || 'unknown@bluedataconsulting.in',
                buddyName: params.get('buddyName') || params.get('Buddy Name') || 'Unknown Buddy',
                hrRep: params.get('hrRep') || params.get('HR Representative') || 'Unknown HR',
                status: params.get('status') || params.get('Status') || 'Documents Pending'
            };

            if (candidateData.name === 'Unknown Name') {
                showAlert('No candidate specified. Please use a valid link.', 'error');
                return;
            }

            // Update UI with candidate information
            updateCandidateUI();
            showAlert('Candidate information loaded successfully!', 'success');

            // Optional: Validate data with Airtable if needed
            if (candidateData.id !== 'Unknown ID' && AIRTABLE_CONFIG.apiKey !== 'AIRTABLE_API_KEY') {
                await validateWithAirtable();
            }
        }

        // Optional: Validate candidate data with Airtable
        async function validateWithAirtable() {
            try {
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableId}/${candidateData.id}`, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Airtable validation successful:', data);
                } else {
                    console.warn('Airtable validation failed, but proceeding with URL data');
                }
            } catch (error) {
                console.warn('Airtable validation error:', error);
            }
        }

        // Update UI with candidate information
        function updateCandidateUI() {
            document.getElementById('candidateGreeting').textContent = 
                `Welcome, ${candidateData.name}! Please upload the required documents`;
            
            // Show candidate info card
            const infoCard = document.getElementById('candidateInfoCard');
            document.getElementById('candidatePosition').textContent = 
                candidateData.position !== 'Unknown Position' ? candidateData.position : 'Not specified';
            document.getElementById('candidateDepartment').textContent = 
                candidateData.department !== 'Unknown Department' ? candidateData.department : 'Not specified';
            document.getElementById('candidateStartDate').textContent = 
                candidateData.startDate !== 'Unknown Date' ? candidateData.startDate : 'Not specified';
            document.getElementById('candidateHR').textContent = 
                candidateData.hrRep !== 'Unknown HR' ? candidateData.hrRep : 'Not specified';
            
            // Only show info card if we have real data
            if (candidateData.position !== 'Unknown Position' || 
                candidateData.department !== 'Unknown Department' || 
                candidateData.startDate !== 'Unknown Date' || 
                candidateData.hrRep !== 'Unknown HR') {
                infoCard.style.display = 'block';
            }
        }

        // Handle file upload
        function handleFileUpload(type) {
            const fileInput = document.getElementById(type + 'File');
            const fileInfo = document.getElementById(type + 'Info');
            const fileName = document.getElementById(type + 'FileName');
            const fileSize = document.getElementById(type + 'FileSize');
            const section = document.getElementById(type + 'Section');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const validation = validateFile(file, type);
                
                if (!validation.valid) {
                    showAlert(validation.message, 'error');
                    fileInput.value = '';
                    return;
                }

                uploadedFiles[type] = file;
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.classList.add('show');
                section.classList.add('completed', 'success-animation');
                section.classList.remove('active');
                
                updateProgress();
                showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} document uploaded successfully!`, 'success');
            }
        }

        // Validate file
        function validateFile(file, type) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];

            if (file.size > maxSize) {
                return { valid: false, message: 'File size must be less than 5MB.' };
            }

            if (!allowedTypes.includes(file.type)) {
                return { valid: false, message: 'Please upload only PDF, JPG, JPEG, or PNG files.' };
            }

            if (type === 'identity' && file.size < 50 * 1024) {
                return { valid: false, message: 'Identity document seems too small. Please ensure it is clear and readable.' };
            }

            return { valid: true };
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Update progress bar and steps
        function updateProgress() {
            const uploadedCount = Object.values(uploadedFiles).filter(file => file !== null).length;
            const progressPercentage = (uploadedCount / 3) * 100;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;

            // Update step indicators
            for (let i = 1; i <= uploadedCount; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.add('bg-green-500', 'text-white');
                step.classList.remove('bg-gray-200', 'text-gray-600');
            }

            if (uploadedCount < 3) {
                const nextStep = document.getElementById(`step${uploadedCount + 1}`);
                nextStep.classList.add('bg-indigo-500', 'text-white');
                nextStep.classList.remove('bg-gray-200', 'text-gray-600');
            }

            // Update submit button
            const submitBtn = document.getElementById('submitBtn');
            if (uploadedCount === 3) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit All Documents ‚úì';
                submitBtn.classList.add('success-animation');
                document.getElementById('step4').classList.add('bg-green-500', 'text-white');
                document.getElementById('step4').classList.remove('bg-gray-200', 'text-gray-600');
            } else {
                submitBtn.disabled = true;
                submitBtn.textContent = `Submit Documents (${uploadedCount}/3)`;
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Submit documents to Airtable
        async function submitDocuments() {
            const uploadedCount = Object.values(uploadedFiles).filter(file => file !== null).length;
            if (uploadedCount !== 3) {
                showAlert('Please upload all three required documents before submitting.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<span class="loading"></span>Submitting documents...';
            submitBtn.disabled = true;

            try {
                // Convert files to base64
                const attachments = {};
                
                for (const [type, file] of Object.entries(uploadedFiles)) {
                    if (file) {
                        const base64 = await fileToBase64(file);
                        const base64Data = base64.split(',')[1]; // Remove data:image/jpeg;base64, prefix
                        
                        attachments[`${type}_document`] = [{
                            filename: `${candidateData.name}_${type}_${Date.now()}.${file.name.split('.').pop()}`,
                            type: file.type,
                            size: file.size,
                            url: base64 // In real implementation, you'd upload to a file storage service first
                        }];
                    }
                }

                // Update Airtable record
                const updatePayload = {
                    fields: {
                        'Status': 'Documents Submitted',
                        'Document Submission Date': new Date().toISOString().split('T')[0],
                        'Identity Document': attachments.identity_document,
                        'Address Proof': attachments.address_document,
                        'Offer Letter': attachments.offer_document,
                        'Notes': (candidateData.notes || '') + `\nDocuments submitted on ${new Date().toLocaleString()}`
                    }
                };

                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableId}/${candidateData.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatePayload)
                });

                if (response.ok) {
                    showAlert('üéâ Documents submitted successfully! Your HR representative will review them shortly.', 'success');
                    
                    // Update UI to show completion
                    submitBtn.innerHTML = '‚úÖ Documents Submitted Successfully';
                    submitBtn.classList.add('bg-green-500');
                    
                    // Send notification email (you would implement this server-side)
                    await sendNotificationEmail();
                    
                } else {
                    throw new Error('Failed to update Airtable record');
                }

            } catch (error) {
                console.error('Submission error:', error);
                showAlert(`Error submitting documents: ${error.message}. Please try again or contact HR.`, 'error');
                
                submitBtn.innerHTML = 'Submit Documents - Try Again';
                submitBtn.disabled = false;
            }
        }

        // Send notification email (placeholder - implement server-side)
        async function sendNotificationEmail() {
            try {
                // This should be implemented as a server-side endpoint
                const emailPayload = {
                    to: candidateData.hrRep || 'hr@bluedataconsulting.in',
                    cc: candidateData.buddyEmail,
                    subject: `Documents Submitted - ${candidateData.name}`,
                    body: `
                        Documents have been submitted by ${candidateData.name} for the ${candidateData.position} position.
                        
                        Candidate Details:
                        - Name: ${candidateData.name}
                        - Email: ${candidateData.email}
                        - Position: ${candidateData.position}
                        - Department: ${candidateData.department}
                        - Start Date: ${candidateData.startDate}
                        
                        Please review the uploaded documents in Airtable.
                    `
                };
                
                // await fetch('/api/send-notification', { ... });
                console.log('Notification email payload:', emailPayload);
                
            } catch (error) {
                console.error('Failed to send notification:', error);
            }
        }

        // Show alert with different types
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `mt-4 p-4 rounded-lg ${getAlertClass(type)}`;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, type === 'success' ? 7000 : 5000);
        }

        function getAlertClass(type) {
            switch (type) {
                case 'success': return 'bg-green-100 text-green-700 border border-green-200';
                case 'error': return 'bg-red-100 text-red-700 border border-red-200';
                case 'warning': return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
                default: return 'bg-blue-100 text-blue-700 border border-blue-200';
            }
        }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const uploadSections = document.querySelectorAll('.upload-section');
            const types = ['identity', 'address', 'offer'];

            uploadSections.forEach((section, index) => {
                const type = types[index];
                
                section.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    section.classList.add('active');
                });
                
                section.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    if (!section.contains(e.relatedTarget)) {
                        section.classList.remove('active');
                    }
                });
                
                section.addEventListener('drop', (e) => {
                    e.preventDefault();
                    section.classList.remove('active');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById(type + 'File');
                        fileInput.files = files;
                        handleFileUpload(type);
                    }
                });
            });
        }

        // Generate dynamic candidate link for n8n integration
        function generateDynamicCandidateLink(baseUrl, candidateData) {
            const params = new URLSearchParams({
                candidateName: candidateData.candidateName || 'Unknown Name',
                candidateEmail: candidateData.candidateEmail || 'unknown@example.com',
                candidatePhone: candidateData.candidatePhone || 'Unknown Phone',
                position: candidateData.position || 'Unknown Position',
                department: candidateData.department || 'Unknown Department',
                startDate: candidateData.startDate || 'Unknown Date',
                buddyEmail: candidateData.buddyEmail || 'unknown@bluedataconsulting.in',
                buddyName: candidateData.buddyName || 'Unknown Buddy',
                hrRep: candidateData.hrRep || 'Unknown HR',
                recordId: candidateData.recordId || 'Unknown ID'
            });
            
            return `${baseUrl}?${params.toString()}`;
        }

        // Debug function to show current URL parameters
        function debugUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            console.log('Current URL Parameters:');
            for (const [key, value] of params) {
                console.log(`${key}: ${value}`);
            }
            console.log('Candidate Data:', candidateData);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeCandidateData();
            setupDragAndDrop();
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey && !document.getElementById('submitBtn').disabled) {
                    submitDocuments();
                }
            });

            // Auto-focus first upload section
            document.getElementById('identitySection').scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    </script>
</body>
</html>
